<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Offers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar for filters -->
    <div class="col-md-3 col-lg-2 bg-light p-3">
      <h5>Filter by Store</h5>
      <ul class="list-group mb-4" id="store-list">
        <!-- Store filters will be dynamically inserted here -->
      </ul>
      
      <h5>Filter by Category</h5>
      <ul class="list-group" id="category-list">
        <!-- Category filters will be dynamically inserted here -->
      </ul>
    </div>

    <!-- Main content area for products -->
    <div class="col-md-9 col-lg-10 mt-3">
      <h1 class="mb-4">Current Product Offers</h1>
      <div class="row" id="product-list">
        <!-- Products will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Modal for image preview -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <img src="" id="modalImage" class="img-fluid" alt="Product Image">
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
<script>
// Function to load the SQLite database
async function loadDatabase() {
  try {
    console.log('Fetching database file...');
    // Fetch the SQLite database file (ensure it's in the same directory)
    const response = await fetch('data.db');
    const arrayBuffer = await response.arrayBuffer();

    console.log('Database file loaded, initializing SQL.js...');

    // Load the database using SQL.js
    const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.wasm` });
    const db = new SQL.Database(new Uint8Array(arrayBuffer));

    console.log('Database initialized, running query...');

    // Query the database
    const query = `
      SELECT 
        p.ean, p.description, p.categories_da, p.categories_en, p.image, 
        s.name AS store_name, s.brand AS store_brand, s.city AS store_city, s.street AS store_street, s.zip AS store_zip, s.latitude, s.longitude,
        o.currency, o.discount, o.newPrice, o.originalPrice, o.percentDiscount, o.stock, o.stockUnit, o.startTime, o.endTime, o.lastUpdate
      FROM offers o
      JOIN products p ON o.ean = p.ean
      JOIN stores s ON o.store_id = s.id
    `;
    
    const results = db.exec(query);
    
    if (results.length > 0) {
      console.log('Query executed successfully, displaying results...');
      displayProducts(results[0].values);  // Pass the results to display function
    } else {
      console.log('No data found in the database.');
    }
  } catch (error) {
    console.error('Error loading database:', error);
  }
}

// Function to display products
function displayProducts(products) {
  const productList = document.getElementById('product-list');
  productList.innerHTML = '';  // Clear any existing products

  products.forEach(item => {
    const [
      ean, description, categories_da, categories_en, image,
      store_name, store_brand, store_city, store_street, store_zip, latitude, longitude,
      currency, discount, newPrice, originalPrice, percentDiscount, stock, stockUnit, startTime, endTime, lastUpdate
    ] = item;

    const storeAddress = `${store_street || 'Unknown'}, ${store_city || 'Unknown'}, ${store_zip || 'Unknown'}`;
    const storeCoordinates = `${latitude}, ${longitude}`;

    // Create card element for each product
    const productCard = document.createElement('div');
    productCard.classList.add('col-6', 'col-md-3', 'mb-4');
    productCard.innerHTML = `
      <div class="card text-center">
        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-bs-image="${image ? image : 'placeholder.jpg'}">
          <img src="${image ? image : 'placeholder.jpg'}" class="card-img-top img-thumbnail" alt="${description}">
        </a>
        <div class="card-body p-2">
          <h6 class="card-title">${description}</h6>
          <p class="card-text"><small><strong>Category:</strong> ${categories_en || 'N/A'}</small></p>
          <p class="card-text"><small><strong>Original Price:</strong> ${originalPrice} ${currency}</small></p>
          <p class="card-text"><small><strong>New Price:</strong> ${newPrice} ${currency}</small></p>
          <p class="card-text"><small><strong>Discount:</strong> ${percentDiscount}% (${discount} ${currency})</small></p>
          <p class="card-text"><small><strong>Stock:</strong> ${stock} ${stockUnit}</small></p>
          <p class="card-text"><small><strong>Offer Valid Until:</strong> ${new Date(endTime).toLocaleDateString()}</small></p>
          <p class="card-text"><small><strong>Last Updated:</strong> ${new Date(lastUpdate).toLocaleDateString()}</small></p>
          <p class="card-text"><small><strong>Store:</strong> ${store_name} (${store_brand})</small></p>
          <p class="card-text"><small><strong>Location:</strong> ${storeAddress}</small></p>
          <p class="card-text"><small><strong>Coordinates:</strong> ${storeCoordinates}</small></p>
        </div>
      </div>
    `;

    productList.appendChild(productCard);
  });

  console.log('Products displayed successfully.');
  
  // Add event listener for image click to open modal
  document.querySelectorAll('[data-bs-toggle="modal"]').forEach(element => {
    element.addEventListener('click', function(event) {
      const imageUrl = this.getAttribute('data-bs-image');
      document.getElementById('modalImage').src = imageUrl;
    });
  });
}

// Load the database and offers on page load
window.onload = loadDatabase;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
